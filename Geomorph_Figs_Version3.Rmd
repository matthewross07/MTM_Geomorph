---
title: "MTM_Geomorph_Figs3.0"
author: "Matthew Ross"
date: "June 14, 2017"
output: 
  html_document: 
    fig_height: 6
    fig_width: 8
editor_options: 
  chunk_output_type: console
---

#Geomorph open source style

```{r,include=F}
library(stringr)
library(raster)
library(tidyverse)
library(magrittr)
library(rgdal)
library(rgeos)
library(shapefiles)
library(maptools)
library(leaflet)
library(velox)
library(foreach)
library(snow)
library(parallel)
library(doParallel)
library(Hmisc)
library(tidyverse)
library(reshape2)
library(plotly)
library(scales)
library(broom)
library(RcppRoll)
library(zoo)

#Set ggplot2 theme
matt_theme <- theme_set(theme_bw())
matt_theme<- theme_update(axis.line = element_line(colour = "black"),
                          panel.grid.major=element_blank(),
                          panel.grid.minor = element_blank(),
                          panel.background = element_blank(),
                          text=element_text(family='sans','plain','black',14,0.5,0.5,0,0),
                          plot.margin=unit(c(6,20,6,2),'pt')
)

```


##Slope Area Plots

Below are a first run at all of the new plots based on whole watersheds, tauDEM d-infinity algorithm.

###Static Slope Area

equally sized bins for Slope area plots (each point is a mean of ~ 10000 slope values. )
```{r}
#Loads stack.df a wide data frame with all rasters for 5 sites

load('UAA.E.Slope.RData')
load('ras.stack.RData')




#Add an index column
stack.df$index <- 1:nrow(stack.df)
#Gather data into one long data frame
long.df <- stack.df %>%
  gather(Key,value,-Site,-index,na.rm=T)
#Remove elevation data
slp.aa <- long.df %>%
  filter(!grepl('\\.e',Key)) %>%
  mutate(fdr.type = ifelse(grepl('8',Key),'f.8','f.inf')) %>%
  mutate(Data=ifelse(grepl('shed',Key),'UAA','Slope')) %>%
  mutate(Treatment = ifelse(grepl('new',Key),'Post-mining','Pre-mining')) %>%
  dcast(Site+index+fdr.type+Treatment ~ Data,value.var='value') %>%
  mutate(UAA=ifelse(fdr.type=='f.8',UAA*100,round(UAA,0)*10)) %>% #Make upslope accumulated area in meteres squared
  group_by(Site) %>%
  mutate(Bins=ifelse(UAA < 10000,cut2(UAA,m=2000),cut2(UAA,m=400))) %>%
  mutate(status=factor(Treatment,levels=c('Pre-mining','Post-mining')))




slp.aa.sum <- slp.aa %>%
  group_by(Site,fdr.type,status,Bins) %>%
  summarise(Slope=mean(Slope),UAA=mean(UAA)) %>%
  mutate(st.typ = paste(Site,status,sep='-'))



full.uaa <- data.frame(UAA=rep(seq(min(slp.aa.sum$UAA),max(slp.aa.sum$UAA),100),10)) %>%
  mutate(st.typ=rep(unique(slp.aa.sum$st.typ),each=length(unique(UAA)))) %>%
  mutate(Site=str_split_fixed(st.typ,'-',n=2)[,1]) %>%
  mutate(status=str_split_fixed(st.typ,'-',n=2)[,2] %>%
           factor(.,levels=c('Pre-mining','Post-mining'))) 


slp.aa.dif <- slp.aa.sum %>% 
  filter(fdr.type == 'f.inf') %>%
  full_join(.,full.uaa,by=c('UAA','st.typ','Site','status')) %>%
  group_by(st.typ,Site,status) %>% 
  arrange(st.typ,UAA) %>%
  mutate(Slope1=na.approx(Slope,na.rm=F)) %>%
  mutate(Slope2 = roll_meanr(Slope1,5)) %>%
  mutate(derv=roll_meanr(c(NA,diff(Slope2)),11)) %>%
  mutate(rawderv=c(NA,diff(Slope1)/diff(UAA))) %>%
  filter(UAA < 10^6)


g.aa.dif <- slp.aa.dif  %>%
ggplot(., aes(x=UAA,y=derv,color=status)) + 
  geom_point() +
  facet_wrap(~Site) +   
  theme(legend.position = c(0.8,.25)) + 
  scale_color_manual(values=c('Blue','Red'))

g.aa.dif + scale_x_log10() 


#Finf
g.aa.slp <- slp.aa.sum %>% 
  filter(fdr.type=='f.inf') %>%
  ggplot(aes(x=UAA,y=Slope,color=status)) + 
  geom_point(shape=1) + 
  scale_y_log10(breaks=c(0.01,0.1,1),
                labels=c(0.01,0.1,1),
                limits=c(0.01,1)) + 
  facet_wrap(~Site) + 
  theme(legend.position = c(0.8,.25)) + 
  scale_color_manual(values=c('Blue','Red')) 

g.aa.slp + scale_x_log10()

g.aa.slp +   
  ylab('Slope (m/m)') +
  xlab(expression(paste('Area (',m^2,')'))) + 
    scale_x_log10(breaks=trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) 



```


#Check raw curvature plot. 
```{r}
library('spatialEco')
?curvature

s <- all.list[[1]]
plot(s)
old.test <- curvature
new.test 


```








###Slope vs UAA derivative
```{r}
g.aa.dif +  scale_x_log10(breaks=trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)),
              limits=c(150,10^5.5)) 
```


###Break Identification
```{r}
names(slp.aa.dif)

first.max <- slp.aa.dif %>%
  filter(fdr.type=='f.inf') %>%
  filter(status=='Pre-mining') %>%
  group_by(Site) %>%
  filter(round(derv,3) == 0) %>%
  filter(UAA == min(UAA)) 

break.min <- slp.aa.dif %>%
  filter(fdr.type=='f.inf') %>%
  filter(status=='Pre-mining') %>%
  group_by(Site) %>%
  filter(derv <= min(derv+.0001,na.rm=T)) %>%
  filter(UAA == min(UAA))
  
converge <- slp.aa.dif %>%  
  filter(fdr.type=='f.inf') %>%
  filter(status=='Pre-mining') %>%
  filter(UAA> min(break.min$UAA)) %>% 
  group_by(Site) %>%
  mutate(roller=roll_maxl(abs(derv),10)) %>%
  filter(round(roller,3) == 0) %>%
  filter(UAA == min(UAA))


sa.brk <- data.frame(Site=first.max$Site,
                     b1=first.max$UAA,
                     b2=break.min$UAA,
                     b3 = converge$UAA,stringsAsFactors = F) %>%
  gather(.,b.zone,breaks,-Site)


g.brk <- g.aa.slp +   
  ylab('Slope (m/m)') +
  xlab('area') + 
    scale_x_log10() + 
  theme(legend.position=c(.8,.25)) +
  geom_vline(data=sa.brk,aes(xintercept=breaks)) 

ggplotly(g.brk)


g.dif.brk <- g.aa.dif + 
  xlab('Area') + 
  ylab('Slope (m/m)') + 
  scale_x_log10() + 
  geom_vline(data=sa.brk, aes(xintercept=breaks))  


g.dif.brk
```


###Zone 4 regressions

```{r}
slp.aa.brks <- left_join(slp.aa.sum,sa.brk,by='Site') %>%
  filter(fdr.type=='f.inf') %>%
  filter(b.zone == 'b3') %>%
  filter(UAA >= breaks) %>%
  group_by(Site) %>%
  do(tidy(lm(log10(Slope) ~ log10(UAA) * status, data=.))) #%>%
  filter(term == 'log10(UAA)') %>%
  mutate(theta=estimate)

slp.aa.brks
```


###Slope as STD instead of mean as SI
```{r}
slp.aa.sd <- slp.aa %>%
  group_by(Site,fdr.type,status,Bins) %>%
  summarise(Slope=sd(Slope),UAA=mean(UAA)) %>%
  mutate(st.typ = paste(Site,status,sep='-'))

g.aa.sd <- slp.aa.sd %>% 
  filter(fdr.type=='f.inf') %>%
  ggplot(aes(x=UAA,y=Slope,color=status)) + 
  geom_point(shape=1) + 
  facet_wrap(~Site) + 
  theme(legend.position = c(0.8,.25)) + 
  scale_color_manual(values=c('Blue','Red'))# +
  scale_x_log10(breaks=trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))
  
g.aa.sd + scale_x_log10() + 
    geom_vline(data=sa.brk,aes(xintercept=value))


```


###Slope Area interactive 
  (expresssion issues make labels and ticks meaningless, but useful for zooming)

```{r}
ggplotly(g.aa.slp + scale_x_log10())
```


##CAD plots

Again with D-Infinity

###Static CAD
```{r}

#Generate an ecdf of CAD using tidy framework
cad <- slp.aa %>% 
  filter(fdr.type=='f.inf') %>% 
  group_by(Site,status,UAA) %>%
  summarise(Freq=n()) %>%
  arrange(Site,status,desc(UAA)) %>%
  mutate(Cume_Freq=cumsum(Freq)) %>%
  mutate(st.typ=paste(Site,status,'-')) 



cad.dif <- cad %>% 
  full_join(.,full.uaa,by=c('UAA','st.typ','Site','status')) %>%
  group_by(st.typ,Site,status) %>% 
  arrange(st.typ,UAA) %>%
  mutate(Cume1=na.approx(Cume_Freq,na.rm=F)) %>%
  mutate(Cume2 = roll_meanr(Cume1,5)) %>%
  mutate(derv=roll_meanr(c(NA,diff(Cume2)),11)) %>%
  mutate(rawderv=c(NA,diff(Cume1)/diff(UAA))) %>%
  filter(UAA < 10^6)



#Generate plot
g.cad <- cad %>%
  ggplot(.,aes(x=UAA,y=Cume_Freq,color=status,size=status)) +
  geom_point() + 
  scale_size_manual(values=c(2,.8)) + 
  scale_color_manual(values=c('blue','red')) + 
  facet_wrap(~Site) + 
  theme(legend.position = c(0.8,.25)) 

summary(cad.dif)

g.cad +   
  ylab('Slope (m/m)') +
  xlab(expression(paste('Area (',m^2,')'))) + 
  scale_y_log10(breaks=trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
    scale_x_log10(breaks=trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) + 
  xlab(expression(paste('Area (',m^2,')'))) + 
  ylab(expression(paste('Cumulative Area (',m^2,')'))) + 
      geom_vline(data=sa.brk,aes(xintercept=breaks))


```


###Cad Diff Plot w/ SA breaks
```{r}
g.cad.dif <- cad.dif %>%
  ggplot(.,aes(x=UAA,y=derv,color=status,size=status)) + 
  geom_point() + 
  scale_size_manual(values=c(2,.8)) + 
  scale_color_manual(values=c('blue','red')) + 
  facet_wrap(~Site) + 
  theme(legend.position = c(0.8,.25)) + 
  scale_x_log10() +   
  geom_vline(data=sa.brk,aes(xintercept=breaks))

  
g.cad.dif

```


###Interactive CAD

takes a long time to run and slows down html, cutting out for now. 
```{r, eval=F}
ggplotly(g.cad + 
           scale_x_log10() + 
           scale_y_log10())
```


###Cad diff plot

This difference plot helps distinguish breaks between fluvial and colluvial process zones
```{r}
library(zoo)


full.uaa <- data.frame(UAA=rep(seq(min(slp.aa.sum$UAA),max(slp.aa.sum$UAA),200),10)) %>%
  mutate(st.typ=rep(unique(slp.aa.sum$st.typ),each=length(unique(UAA)))) %>%
  mutate(Site=str_split_fixed(st.typ,'-',n=2)[,1]) %>%
  mutate(status=str_split_fixed(st.typ,'-',n=2)[,2] %>%
           factor(.,levels=c('Pre-mining','Post-mining'))) 


cad.dif <- cad %>% 
  ungroup(.) %>%
  full_join(.,full.uaa,by=c('UAA','st.typ','Site','status')) %>%
  group_by(st.typ,Site,status) %>% 
  arrange(st.typ,UAA) %>%
  mutate(cfreq1=na.approx(Cume_Freq,na.rm=F)) %>%
  mutate(cfreq2 = roll_meanr(cfreq1,3)) %>%
  mutate(derv=roll_meanr(c(NA,diff(cfreq2)/diff(UAA)),5)) 

summary(cad.dif)
tail(cad.dif)


g.cad.dif <- cad.dif %>%
  ggplot(.,aes(x=UAA,y=derv,color=status)) + 
  geom_point() + 
  facet_wrap(~Site) + 
  scale_color_manual(values=c('blue','red')) + 
  theme(legend.position=c(.8,.25))
  
g.cad.dif + 
      scale_x_log10(breaks=trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))

```



##Energy Index


###Energy Index, UAA Not Raised to any power

The energy index as calcuated here is a simple multiplication of slope X upslope accumulated area, which provides an indication of the total energy available for moving material on any given plot of land. 
```{r}
#First create energy index column rounded to whole integer
slp.aa$EI <- round(slp.aa$UAA*slp.aa$Slope,0)


#Then create ecdf of ei
ei <- slp.aa %>% 
  filter(fdr.type=='f.inf') %>% 
  group_by(Site,status,EI) %>%
  summarise(Freq=n()) %>%
  arrange(Site,status,desc(EI))  %>%
  mutate(Cume_Freq=cumsum(Freq)/sum(Freq))

g.ei <- ggplot(ei,aes(x=EI,y=Cume_Freq,color=status)) + 
  geom_point() +
  scale_x_log10() + 
  facet_wrap(~Site) + 
  scale_y_log10() + 
  scale_color_manual(values=c('blue','red')) + 
  theme(legend.position=c(0.8,.25))

g.ei

```

###Energy Index UAA square root of UAA

```{r}
slp.aa$EI.sq <- round((slp.aa$UAA^.5)*slp.aa$Slope,0)

#Then create ecdf of ei
ei.sq <- slp.aa %>% 
  filter(fdr.type=='f.inf') %>% 
  group_by(Site,status,EI.sq) %>%
  summarise(Freq=n()) %>%
  arrange(Site,status,desc(EI.sq))  %>%
  mutate(Cume_Freq=cumsum(Freq)/sum(Freq))

g.ei.sq <- ggplot(ei.sq,aes(x=EI.sq,y=Cume_Freq,color=status)) + 
  geom_point() +
  scale_x_log10() + 
  facet_wrap(~Site) + 
  scale_y_log10() + 
  scale_color_manual(values=c('blue','red')) + 
  theme(legend.position=c(0.8,.25))

g.ei.sq
```




