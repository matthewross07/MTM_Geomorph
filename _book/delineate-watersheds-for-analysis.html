<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3 Delineate watersheds for analysis | Methods for: Identifying geomorphic process domains in synthetic landscapes of West Virginia, USA</title>
  <meta name="description" content="3 Delineate watersheds for analysis | Methods for: Identifying geomorphic process domains in synthetic landscapes of West Virginia, USA" />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="3 Delineate watersheds for analysis | Methods for: Identifying geomorphic process domains in synthetic landscapes of West Virginia, USA" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3 Delineate watersheds for analysis | Methods for: Identifying geomorphic process domains in synthetic landscapes of West Virginia, USA" />
  
  
  

<meta name="author" content="Dr. Matthew Ross and Dr. Kristin Jaeger" />
<meta name="author" content="matt.ross(at)colostate.edu" />


<meta name="date" content="2020-08-22" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="identifying-heavily-mined-watersheds.html"/>
<link rel="next" href="analysis-and-figures.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="terrain-analyses-using-taudem.html"><a href="terrain-analyses-using-taudem.html"><i class="fa fa-check"></i><b>1</b> Terrain analyses using TauDEM</a><ul>
<li class="chapter" data-level="1.1" data-path="terrain-analyses-using-taudem.html"><a href="terrain-analyses-using-taudem.html#pit-remove"><i class="fa fa-check"></i><b>1.1</b> Pit remove</a></li>
<li class="chapter" data-level="1.2" data-path="terrain-analyses-using-taudem.html"><a href="terrain-analyses-using-taudem.html#d8"><i class="fa fa-check"></i><b>1.2</b> D8</a><ul>
<li class="chapter" data-level="1.2.1" data-path="terrain-analyses-using-taudem.html"><a href="terrain-analyses-using-taudem.html#flow-direction-with-slope-and-flow-direction"><i class="fa fa-check"></i><b>1.2.1</b> Flow direction with slope and flow direction</a></li>
<li class="chapter" data-level="1.2.2" data-path="terrain-analyses-using-taudem.html"><a href="terrain-analyses-using-taudem.html#flow-accumulation"><i class="fa fa-check"></i><b>1.2.2</b> Flow accumulation</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="terrain-analyses-using-taudem.html"><a href="terrain-analyses-using-taudem.html#d-infinity"><i class="fa fa-check"></i><b>1.3</b> D-Infinity</a><ul>
<li class="chapter" data-level="1.3.1" data-path="terrain-analyses-using-taudem.html"><a href="terrain-analyses-using-taudem.html#flowdir"><i class="fa fa-check"></i><b>1.3.1</b> Flowdir</a></li>
<li class="chapter" data-level="1.3.2" data-path="terrain-analyses-using-taudem.html"><a href="terrain-analyses-using-taudem.html#flow-accumulation-1"><i class="fa fa-check"></i><b>1.3.2</b> Flow accumulation</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="terrain-analyses-using-taudem.html"><a href="terrain-analyses-using-taudem.html#stream-detection"><i class="fa fa-check"></i><b>1.4</b> Stream detection</a><ul>
<li class="chapter" data-level="1.4.1" data-path="terrain-analyses-using-taudem.html"><a href="terrain-analyses-using-taudem.html#threshold-1000-pixels-0.1-km2"><i class="fa fa-check"></i><b>1.4.1</b> Threshold 1000 pixels = 0.1 km2</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="identifying-heavily-mined-watersheds.html"><a href="identifying-heavily-mined-watersheds.html"><i class="fa fa-check"></i><b>2</b> Identifying heavily mined watersheds</a><ul>
<li class="chapter" data-level="2.1" data-path="identifying-heavily-mined-watersheds.html"><a href="identifying-heavily-mined-watersheds.html#project-outlets-with-same-projection-as-rasters"><i class="fa fa-check"></i><b>2.1</b> Project outlets with same projection as rasters</a><ul>
<li class="chapter" data-level="2.1.1" data-path="identifying-heavily-mined-watersheds.html"><a href="identifying-heavily-mined-watersheds.html#convert-river-network-into-shapefile"><i class="fa fa-check"></i><b>2.1.1</b> Convert river network into shapefile</a></li>
<li class="chapter" data-level="2.1.2" data-path="identifying-heavily-mined-watersheds.html"><a href="identifying-heavily-mined-watersheds.html#reproject-outlets-to-same-projection-as-rasters"><i class="fa fa-check"></i><b>2.1.2</b> Reproject outlets to same projection as rasters</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="delineate-watersheds-for-analysis.html"><a href="delineate-watersheds-for-analysis.html"><i class="fa fa-check"></i><b>3</b> Delineate watersheds for analysis</a><ul>
<li class="chapter" data-level="3.1" data-path="delineate-watersheds-for-analysis.html"><a href="delineate-watersheds-for-analysis.html#stack-and-cutup-rasters-to-smaller-extents-for-later-analysis-in-r."><i class="fa fa-check"></i><b>3.1</b> Stack and cutup rasters to smaller extents for later analysis in r.</a></li>
<li class="chapter" data-level="3.2" data-path="delineate-watersheds-for-analysis.html"><a href="delineate-watersheds-for-analysis.html#convert-raster-data-to-data-frames"><i class="fa fa-check"></i><b>3.2</b> Convert raster data to data frames</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="analysis-and-figures.html"><a href="analysis-and-figures.html"><i class="fa fa-check"></i><b>4</b> Analysis and Figures</a><ul>
<li class="chapter" data-level="4.1" data-path="analysis-and-figures.html"><a href="analysis-and-figures.html#a-note-on-proj-4-and-proj-6"><i class="fa fa-check"></i><b>4.1</b> A note on PROJ 4 and PROJ 6</a></li>
<li class="chapter" data-level="4.2" data-path="analysis-and-figures.html"><a href="analysis-and-figures.html#data-prep"><i class="fa fa-check"></i><b>4.2</b> Data Prep</a><ul>
<li class="chapter" data-level="4.2.1" data-path="analysis-and-figures.html"><a href="analysis-and-figures.html#convert-data-to-long-format"><i class="fa fa-check"></i><b>4.2.1</b> Convert data to long format</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="analysis-and-figures.html"><a href="analysis-and-figures.html#figure-1---mining-demonstration"><i class="fa fa-check"></i><b>4.3</b> Figure 1 - Mining demonstration</a></li>
<li class="chapter" data-level="4.4" data-path="analysis-and-figures.html"><a href="analysis-and-figures.html#figure-3-study-map"><i class="fa fa-check"></i><b>4.4</b> Figure 3 Study Map</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="raw-site-summaries.html"><a href="raw-site-summaries.html"><i class="fa fa-check"></i><b>5</b> Raw site summaries</a><ul>
<li class="chapter" data-level="5.1" data-path="raw-site-summaries.html"><a href="raw-site-summaries.html#percent-mining"><i class="fa fa-check"></i><b>5.1</b> Percent mining</a><ul>
<li class="chapter" data-level="5.1.1" data-path="raw-site-summaries.html"><a href="raw-site-summaries.html#elevation"><i class="fa fa-check"></i><b>5.1.1</b> Elevation</a></li>
<li class="chapter" data-level="5.1.2" data-path="raw-site-summaries.html"><a href="raw-site-summaries.html#slope"><i class="fa fa-check"></i><b>5.1.2</b> Slope</a></li>
<li class="chapter" data-level="5.1.3" data-path="raw-site-summaries.html"><a href="raw-site-summaries.html#drainage-density"><i class="fa fa-check"></i><b>5.1.3</b> Drainage density</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="raw-site-summaries.html"><a href="raw-site-summaries.html#total-summary"><i class="fa fa-check"></i><b>5.2</b> Total summary</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="process-zones-with-slope-area-and-cumulative-area-distribution.html"><a href="process-zones-with-slope-area-and-cumulative-area-distribution.html"><i class="fa fa-check"></i><b>6</b> Process Zones with Slope Area and Cumulative Area Distribution</a><ul>
<li class="chapter" data-level="6.1" data-path="process-zones-with-slope-area-and-cumulative-area-distribution.html"><a href="process-zones-with-slope-area-and-cumulative-area-distribution.html#uaa-slope-cutting"><i class="fa fa-check"></i><b>6.1</b> UAA Slope Cutting</a><ul>
<li class="chapter" data-level="6.1.1" data-path="process-zones-with-slope-area-and-cumulative-area-distribution.html"><a href="process-zones-with-slope-area-and-cumulative-area-distribution.html#slope-area-standard-deviation-plots"><i class="fa fa-check"></i><b>6.1.1</b> Slope Area Standard Deviation Plots</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="process-zones-with-slope-area-and-cumulative-area-distribution.html"><a href="process-zones-with-slope-area-and-cumulative-area-distribution.html#sa-break-id"><i class="fa fa-check"></i><b>6.2</b> SA Break ID</a><ul>
<li class="chapter" data-level="6.2.1" data-path="process-zones-with-slope-area-and-cumulative-area-distribution.html"><a href="process-zones-with-slope-area-and-cumulative-area-distribution.html#region-slopes"><i class="fa fa-check"></i><b>6.2.1</b> Region slopes</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="process-zones-with-slope-area-and-cumulative-area-distribution.html"><a href="process-zones-with-slope-area-and-cumulative-area-distribution.html#figure-4---sa-plots"><i class="fa fa-check"></i><b>6.3</b> Figure 4 - SA Plots</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="cumulative-area-distribution.html"><a href="cumulative-area-distribution.html"><i class="fa fa-check"></i><b>7</b> Cumulative area distribution</a><ul>
<li class="chapter" data-level="7.1" data-path="cumulative-area-distribution.html"><a href="cumulative-area-distribution.html#cad-breaks"><i class="fa fa-check"></i><b>7.1</b> Cad breaks</a></li>
<li class="chapter" data-level="7.2" data-path="cumulative-area-distribution.html"><a href="cumulative-area-distribution.html#uaa-density"><i class="fa fa-check"></i><b>7.2</b> UAA Density</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="energy-index.html"><a href="energy-index.html"><i class="fa fa-check"></i><b>8</b> Energy Index</a><ul>
<li class="chapter" data-level="8.1" data-path="energy-index.html"><a href="energy-index.html#figure-6-ei-plots"><i class="fa fa-check"></i><b>8.1</b> Figure 6 EI Plots</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="d-plots.html"><a href="d-plots.html"><i class="fa fa-check"></i><b>9</b> 3D plots</a><ul>
<li class="chapter" data-level="9.1" data-path="d-plots.html"><a href="d-plots.html#terrain-metric-drape"><i class="fa fa-check"></i><b>9.1</b> Terrain metric drape</a></li>
<li class="chapter" data-level="9.2" data-path="d-plots.html"><a href="d-plots.html#draping-zones-over-dem"><i class="fa fa-check"></i><b>9.2</b> Draping zones over DEM</a></li>
<li class="chapter" data-level="9.3" data-path="d-plots.html"><a href="d-plots.html#distribution-of-process-zones-by-site"><i class="fa fa-check"></i><b>9.3</b> Distribution of process zones by site</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="table-of-stats-by-zone.html"><a href="table-of-stats-by-zone.html"><i class="fa fa-check"></i><b>10</b> Table of stats by zone</a></li>
<li class="chapter" data-level="11" data-path="statistical-tests.html"><a href="statistical-tests.html"><i class="fa fa-check"></i><b>11</b> Statistical tests</a></li>
<li class="chapter" data-level="12" data-path="supplemental-informatino.html"><a href="supplemental-informatino.html"><i class="fa fa-check"></i><b>12</b> Supplemental informatino</a></li>
<li class="chapter" data-level="13" data-path="supplement-way-too-much-detail.html"><a href="supplement-way-too-much-detail.html"><i class="fa fa-check"></i><b>13</b> Supplement way too much detail</a><ul>
<li class="chapter" data-level="13.1" data-path="supplement-way-too-much-detail.html"><a href="supplement-way-too-much-detail.html#check-for-differences-between-flow-direction-algorithm-f8-or-f.infinity"><i class="fa fa-check"></i><b>13.1</b> Check for differences between flow direction algorithm (f8 or f.infinity)</a><ul>
<li class="chapter" data-level="13.1.1" data-path="supplement-way-too-much-detail.html"><a href="supplement-way-too-much-detail.html#flow-direction-differnces-in-uplsope-accumulated-area-uaa-for-reference-sites"><i class="fa fa-check"></i><b>13.1.1</b> Flow direction differnces in Uplsope Accumulated Area (UAA) for reference sites</a></li>
<li class="chapter" data-level="13.1.2" data-path="supplement-way-too-much-detail.html"><a href="supplement-way-too-much-detail.html#flow-direction-differences-in-slope"><i class="fa fa-check"></i><b>13.1.2</b> Flow Direction Differences in Slope</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Methods for: Identifying geomorphic process domains in synthetic landscapes of West Virginia, USA</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="delineate-watersheds-for-analysis" class="section level1">
<h1><span class="header-section-number">3</span> Delineate watersheds for analysis</h1>
<p>Now that we have identified watersheds in the previous step, we will use those
pour points to:</p>
<ol style="list-style-type: decimal">
<li><p>Delineate watersheds</p></li>
<li><p>Prepare the terrain metrics within these watersheds for analysis in R</p></li>
<li><p>Save these outputs in a compressed file.</p></li>
</ol>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="delineate-watersheds-for-analysis.html#cb10-1"></a><span class="co">#New Infinity</span></span>
<span id="cb10-2"><a href="delineate-watersheds-for-analysis.html#cb10-2"></a><span class="ex">mpiexec</span> -n 7 areadinf -ang data/out/newinffdr.tif -o data/in/shapefile/approxnew.shp -sca newshedinf.tif</span>
<span id="cb10-3"><a href="delineate-watersheds-for-analysis.html#cb10-3"></a></span>
<span id="cb10-4"><a href="delineate-watersheds-for-analysis.html#cb10-4"></a><span class="ex">mpiexec</span> -n 7 aread8 -p data/out/newdir8.tif -o data/in/shapefile/approxnew.shp -ad8 newshed8.tif</span>
<span id="cb10-5"><a href="delineate-watersheds-for-analysis.html#cb10-5"></a></span>
<span id="cb10-6"><a href="delineate-watersheds-for-analysis.html#cb10-6"></a><span class="ex">mpiexec</span> -n 7 areadinf -ang data/out/oldinffdr.tif -o data/in/shapefile/approxnew.shp -sca oldshedinf.tif</span>
<span id="cb10-7"><a href="delineate-watersheds-for-analysis.html#cb10-7"></a></span>
<span id="cb10-8"><a href="delineate-watersheds-for-analysis.html#cb10-8"></a><span class="ex">mpiexec</span> -n 7 aread8 -p data/out/olddir8.tif -o data/in/shapefile/approxnew.shp -ad8 oldshed8.tif</span></code></pre></div>
<div id="stack-and-cutup-rasters-to-smaller-extents-for-later-analysis-in-r." class="section level2">
<h2><span class="header-section-number">3.1</span> Stack and cutup rasters to smaller extents for later analysis in r.</h2>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="delineate-watersheds-for-analysis.html#cb11-1"></a><span class="co">#Using a new faster raster library called Velox</span></span>
<span id="cb11-2"><a href="delineate-watersheds-for-analysis.html#cb11-2"></a></span>
<span id="cb11-3"><a href="delineate-watersheds-for-analysis.html#cb11-3"></a></span>
<span id="cb11-4"><a href="delineate-watersheds-for-analysis.html#cb11-4"></a><span class="co">#Setup readin paths and crop extents and name order and empty lists</span></span>
<span id="cb11-5"><a href="delineate-watersheds-for-analysis.html#cb11-5"></a><span class="co">#Upslop accumulated area data</span></span>
<span id="cb11-6"><a href="delineate-watersheds-for-analysis.html#cb11-6"></a>uaa.paths &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&#39;data/out/&#39;</span>,<span class="kw">c</span>(<span class="st">&#39;newshedinf.tif&#39;</span>, <span class="st">&#39;oldshedinf.tif&#39;</span>,<span class="st">&#39;newshed8.tif&#39;</span>,<span class="st">&#39;oldshed8.tif&#39;</span>))</span>
<span id="cb11-7"><a href="delineate-watersheds-for-analysis.html#cb11-7"></a><span class="co">#Slope data. </span></span>
<span id="cb11-8"><a href="delineate-watersheds-for-analysis.html#cb11-8"></a>slope.paths &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&#39;data/out/&#39;</span>,<span class="kw">c</span>(<span class="st">&#39;newinfslp.tif&#39;</span>,<span class="st">&#39;oldinfslp.tif&#39;</span>,<span class="st">&#39;newsd8.tif&#39;</span>,<span class="st">&#39;oldsd8.tif&#39;</span>))</span>
<span id="cb11-9"><a href="delineate-watersheds-for-analysis.html#cb11-9"></a><span class="co">#Elevation data. </span></span>
<span id="cb11-10"><a href="delineate-watersheds-for-analysis.html#cb11-10"></a>e.paths &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&#39;data/in/&#39;</span>,<span class="kw">c</span>(<span class="st">&#39;TauNew.tif&#39;</span>,<span class="st">&#39;TauNew.tif&#39;</span>,<span class="st">&#39;TauOldElev.tif&#39;</span>,<span class="st">&#39;TauOldElev.tif&#39;</span>)</span>
<span id="cb11-11"><a href="delineate-watersheds-for-analysis.html#cb11-11"></a><span class="co">#Names for where elevation profiles come from (matched with current shed boundaries or not? New.e.new means New elevatio profiles with new shed boundaries. New.e.old means new elevation with old shed boundaries)</span></span>
<span id="cb11-12"><a href="delineate-watersheds-for-analysis.html#cb11-12"></a>e.names &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;New.e.new&#39;</span>,<span class="st">&#39;New.e.old&#39;</span>,<span class="st">&#39;Old.e.new&#39;</span>,<span class="st">&#39;Old.e.old&#39;</span>)</span>
<span id="cb11-13"><a href="delineate-watersheds-for-analysis.html#cb11-13"></a><span class="co">#Read in raster outlines</span></span>
<span id="cb11-14"><a href="delineate-watersheds-for-analysis.html#cb11-14"></a>sheds &lt;-<span class="st"> </span><span class="kw">raster</span>(uaa.paths[<span class="dv">1</span>]) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">crop</span>(.,<span class="kw">extent</span>(<span class="dv">400000</span>,<span class="dv">470000</span>,<span class="dv">4150000</span>,<span class="dv">4230000</span>))</span>
<span id="cb11-15"><a href="delineate-watersheds-for-analysis.html#cb11-15"></a>oldsheds&lt;-<span class="st"> </span><span class="kw">raster</span>(uaa.paths[<span class="dv">3</span>]) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">crop</span>(.,<span class="kw">extent</span>(<span class="dv">400000</span>,<span class="dv">470000</span>,<span class="dv">4150000</span>,<span class="dv">4230000</span>))</span>
<span id="cb11-16"><a href="delineate-watersheds-for-analysis.html#cb11-16"></a></span>
<span id="cb11-17"><a href="delineate-watersheds-for-analysis.html#cb11-17"></a></span>
<span id="cb11-18"><a href="delineate-watersheds-for-analysis.html#cb11-18"></a><span class="co">#Set all values to 1</span></span>
<span id="cb11-19"><a href="delineate-watersheds-for-analysis.html#cb11-19"></a>sheds[sheds <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb11-20"><a href="delineate-watersheds-for-analysis.html#cb11-20"></a></span>
<span id="cb11-21"><a href="delineate-watersheds-for-analysis.html#cb11-21"></a></span>
<span id="cb11-22"><a href="delineate-watersheds-for-analysis.html#cb11-22"></a></span>
<span id="cb11-23"><a href="delineate-watersheds-for-analysis.html#cb11-23"></a><span class="co">#Turn these into shapefiles</span></span>
<span id="cb11-24"><a href="delineate-watersheds-for-analysis.html#cb11-24"></a>shd.shp &lt;-<span class="st"> </span><span class="kw">gdal_polygonizeR</span>(sheds)</span>
<span id="cb11-25"><a href="delineate-watersheds-for-analysis.html#cb11-25"></a></span>
<span id="cb11-26"><a href="delineate-watersheds-for-analysis.html#cb11-26"></a><span class="co">#Buffer out by 500m to include any ridge changes and reproject to outlet projeciton</span></span>
<span id="cb11-27"><a href="delineate-watersheds-for-analysis.html#cb11-27"></a>shd.shp.buf &lt;-<span class="st"> </span><span class="kw">gBuffer</span>(shd.shp,<span class="dt">width=</span><span class="dv">100</span>) <span class="op">%&gt;%</span></span>
<span id="cb11-28"><a href="delineate-watersheds-for-analysis.html#cb11-28"></a><span class="st">  </span><span class="kw">spTransform</span>(.,<span class="kw">projection</span>(outs)) <span class="op">%&gt;%</span></span>
<span id="cb11-29"><a href="delineate-watersheds-for-analysis.html#cb11-29"></a><span class="st">  </span><span class="kw">disaggregate</span>(.) <span class="op">%&gt;%</span></span>
<span id="cb11-30"><a href="delineate-watersheds-for-analysis.html#cb11-30"></a><span class="st">  </span><span class="kw">SpatialPolygonsDataFrame</span>(.,<span class="dt">data=</span><span class="kw">data.frame</span>(<span class="dt">id=</span><span class="dv">1</span><span class="op">:</span><span class="dv">10</span>))</span>
<span id="cb11-31"><a href="delineate-watersheds-for-analysis.html#cb11-31"></a></span>
<span id="cb11-32"><a href="delineate-watersheds-for-analysis.html#cb11-32"></a></span>
<span id="cb11-33"><a href="delineate-watersheds-for-analysis.html#cb11-33"></a><span class="co">##Plot shd.shp.buf to see if the buffered area includes old watersheds</span></span>
<span id="cb11-34"><a href="delineate-watersheds-for-analysis.html#cb11-34"></a><span class="co"># plot(shd.shp.buf)</span></span>
<span id="cb11-35"><a href="delineate-watersheds-for-analysis.html#cb11-35"></a><span class="co"># plot(oldsheds,col=&#39;black&#39;,add=T)</span></span>
<span id="cb11-36"><a href="delineate-watersheds-for-analysis.html#cb11-36"></a></span>
<span id="cb11-37"><a href="delineate-watersheds-for-analysis.html#cb11-37"></a></span>
<span id="cb11-38"><a href="delineate-watersheds-for-analysis.html#cb11-38"></a><span class="co">#Join these shapefiles to the outlets to get the names (ref or not ref)</span></span>
<span id="cb11-39"><a href="delineate-watersheds-for-analysis.html#cb11-39"></a>shd.names &lt;-<span class="st"> </span><span class="kw">over</span>(shd.shp.buf,outs)</span>
<span id="cb11-40"><a href="delineate-watersheds-for-analysis.html#cb11-40"></a>shd.shp.names &lt;-<span class="st"> </span><span class="kw">spCbind</span>(shd.shp.buf,shd.names)</span>
<span id="cb11-41"><a href="delineate-watersheds-for-analysis.html#cb11-41"></a></span>
<span id="cb11-42"><a href="delineate-watersheds-for-analysis.html#cb11-42"></a></span>
<span id="cb11-43"><a href="delineate-watersheds-for-analysis.html#cb11-43"></a><span class="co">#save(shd.shp.names,file=&#39;data/out/watersheds.RData&#39;)</span></span>
<span id="cb11-44"><a href="delineate-watersheds-for-analysis.html#cb11-44"></a></span>
<span id="cb11-45"><a href="delineate-watersheds-for-analysis.html#cb11-45"></a><span class="co">#Setup storage lists</span></span>
<span id="cb11-46"><a href="delineate-watersheds-for-analysis.html#cb11-46"></a>uaa.stack &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb11-47"><a href="delineate-watersheds-for-analysis.html#cb11-47"></a>slope.stack &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb11-48"><a href="delineate-watersheds-for-analysis.html#cb11-48"></a>e.stack &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb11-49"><a href="delineate-watersheds-for-analysis.html#cb11-49"></a>esu.stacked &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb11-50"><a href="delineate-watersheds-for-analysis.html#cb11-50"></a><span class="co">#Evaluate on 7 cores </span></span>
<span id="cb11-51"><a href="delineate-watersheds-for-analysis.html#cb11-51"></a>cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(<span class="dv">3</span>)</span>
<span id="cb11-52"><a href="delineate-watersheds-for-analysis.html#cb11-52"></a><span class="kw">registerDoParallel</span>(cl,<span class="dt">cores=</span><span class="dv">3</span>)</span>
<span id="cb11-53"><a href="delineate-watersheds-for-analysis.html#cb11-53"></a>all.list &lt;-<span class="st"> </span><span class="kw">foreach</span>(<span class="dt">i =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(shd.names)) <span class="op">%dopar%</span><span class="st"> </span>{</span>
<span id="cb11-54"><a href="delineate-watersheds-for-analysis.html#cb11-54"></a>  <span class="kw">library</span>(raster)</span>
<span id="cb11-55"><a href="delineate-watersheds-for-analysis.html#cb11-55"></a>  <span class="kw">library</span>(rgdal)</span>
<span id="cb11-56"><a href="delineate-watersheds-for-analysis.html#cb11-56"></a>  <span class="kw">library</span>(magrittr)</span>
<span id="cb11-57"><a href="delineate-watersheds-for-analysis.html#cb11-57"></a>  <span class="co">#Read in each Watershed outline to trim data</span></span>
<span id="cb11-58"><a href="delineate-watersheds-for-analysis.html#cb11-58"></a>  shape &lt;-<span class="st"> </span>shd.shp.names[shd.shp.names<span class="op">$</span>Name <span class="op">==</span><span class="st"> </span>shd.names<span class="op">$</span>Name[i],]</span>
<span id="cb11-59"><a href="delineate-watersheds-for-analysis.html#cb11-59"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(uaa.paths)){</span>
<span id="cb11-60"><a href="delineate-watersheds-for-analysis.html#cb11-60"></a>      <span class="co">#Read in watershed delineations and crop to single watershed</span></span>
<span id="cb11-61"><a href="delineate-watersheds-for-analysis.html#cb11-61"></a>      shed &lt;-<span class="st"> </span><span class="kw">raster</span>(uaa.paths[j]) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">crop</span>(.,shape)</span>
<span id="cb11-62"><a href="delineate-watersheds-for-analysis.html#cb11-62"></a>      <span class="co">#Store this cropped watershed uaa tif in a list</span></span>
<span id="cb11-63"><a href="delineate-watersheds-for-analysis.html#cb11-63"></a>      uaa.stack[[j]] &lt;-<span class="st"> </span>shed</span>
<span id="cb11-64"><a href="delineate-watersheds-for-analysis.html#cb11-64"></a>      <span class="co">#Read in slope raster and crop</span></span>
<span id="cb11-65"><a href="delineate-watersheds-for-analysis.html#cb11-65"></a>      slope &lt;-<span class="st"> </span><span class="kw">raster</span>(slope.paths[j]) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">crop</span>(.,shape)</span>
<span id="cb11-66"><a href="delineate-watersheds-for-analysis.html#cb11-66"></a>      <span class="co">#Set Slope values outside of watershed to NA</span></span>
<span id="cb11-67"><a href="delineate-watersheds-for-analysis.html#cb11-67"></a>      slope[<span class="kw">is.na</span>(shed)] &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb11-68"><a href="delineate-watersheds-for-analysis.html#cb11-68"></a>      <span class="co">#Store in slope stack</span></span>
<span id="cb11-69"><a href="delineate-watersheds-for-analysis.html#cb11-69"></a>      slope.stack[[j]] &lt;-<span class="st"> </span>slope</span>
<span id="cb11-70"><a href="delineate-watersheds-for-analysis.html#cb11-70"></a>      <span class="co">#Samesies with elevation</span></span>
<span id="cb11-71"><a href="delineate-watersheds-for-analysis.html#cb11-71"></a>      e &lt;-<span class="st"> </span><span class="kw">raster</span>(e.paths[j]) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">crop</span>(.,shape)</span>
<span id="cb11-72"><a href="delineate-watersheds-for-analysis.html#cb11-72"></a>      e[<span class="kw">is.na</span>(shed)] &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb11-73"><a href="delineate-watersheds-for-analysis.html#cb11-73"></a>      e.stack[[j]] &lt;-<span class="st"> </span>e</span>
<span id="cb11-74"><a href="delineate-watersheds-for-analysis.html#cb11-74"></a>  }</span>
<span id="cb11-75"><a href="delineate-watersheds-for-analysis.html#cb11-75"></a>  esu.stacked[[i]] &lt;-<span class="st"> </span><span class="kw">stack</span>(<span class="kw">c</span>(e.stack,slope.stack,uaa.stack)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">trim</span>(.)</span>
<span id="cb11-76"><a href="delineate-watersheds-for-analysis.html#cb11-76"></a>}</span>
<span id="cb11-77"><a href="delineate-watersheds-for-analysis.html#cb11-77"></a><span class="kw">endCluster</span>()</span>
<span id="cb11-78"><a href="delineate-watersheds-for-analysis.html#cb11-78"></a><span class="kw">names</span>(all.list) &lt;-<span class="st"> </span>shd.names<span class="op">$</span>Name</span>
<span id="cb11-79"><a href="delineate-watersheds-for-analysis.html#cb11-79"></a></span>
<span id="cb11-80"><a href="delineate-watersheds-for-analysis.html#cb11-80"></a></span>
<span id="cb11-81"><a href="delineate-watersheds-for-analysis.html#cb11-81"></a><span class="co">#save(all.list, file=&#39;data/out/ras.stack.ref.RData&#39;)</span></span></code></pre></div>
</div>
<div id="convert-raster-data-to-data-frames" class="section level2">
<h2><span class="header-section-number">3.2</span> Convert raster data to data frames</h2>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="delineate-watersheds-for-analysis.html#cb12-1"></a><span class="co">#Loads in all list which is a list of all sites</span></span>
<span id="cb12-2"><a href="delineate-watersheds-for-analysis.html#cb12-2"></a><span class="kw">load</span>(<span class="st">&#39;data/out/ras.stack.ref.RData&#39;</span>)</span>
<span id="cb12-3"><a href="delineate-watersheds-for-analysis.html#cb12-3"></a></span>
<span id="cb12-4"><a href="delineate-watersheds-for-analysis.html#cb12-4"></a><span class="kw">library</span>(doParallel) <span class="co">#to do parallel processing</span></span>
<span id="cb12-5"><a href="delineate-watersheds-for-analysis.html#cb12-5"></a><span class="kw">library</span>(parallel) <span class="co"># to register parallel processing</span></span>
<span id="cb12-6"><a href="delineate-watersheds-for-analysis.html#cb12-6"></a><span class="kw">library</span>(foreach) <span class="co"># to do parallel processing as a forloop</span></span>
<span id="cb12-7"><a href="delineate-watersheds-for-analysis.html#cb12-7"></a><span class="co">#Evaluate on 7 cores</span></span>
<span id="cb12-8"><a href="delineate-watersheds-for-analysis.html#cb12-8"></a>cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(<span class="dv">3</span>) <span class="co">#make a cluster with 3 cores</span></span>
<span id="cb12-9"><a href="delineate-watersheds-for-analysis.html#cb12-9"></a><span class="kw">registerDoParallel</span>(cl,<span class="dt">cores=</span><span class="dv">3</span>) <span class="co">#tell parallel processor to use 3 cores</span></span>
<span id="cb12-10"><a href="delineate-watersheds-for-analysis.html#cb12-10"></a></span>
<span id="cb12-11"><a href="delineate-watersheds-for-analysis.html#cb12-11"></a>stack.list &lt;-<span class="st"> </span><span class="kw">foreach</span>(<span class="dt">i=</span><span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(all.list)) <span class="op">%dopar%</span><span class="st"> </span>{</span>
<span id="cb12-12"><a href="delineate-watersheds-for-analysis.html#cb12-12"></a>  <span class="kw">library</span>(raster)</span>
<span id="cb12-13"><a href="delineate-watersheds-for-analysis.html#cb12-13"></a>  <span class="kw">library</span>(dplyr)</span>
<span id="cb12-14"><a href="delineate-watersheds-for-analysis.html#cb12-14"></a>  <span class="kw">library</span>(magrittr)</span>
<span id="cb12-15"><a href="delineate-watersheds-for-analysis.html#cb12-15"></a>  l &lt;-<span class="st"> </span><span class="kw">extract</span>(all.list[[i]]) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.data.frame</span>(.) <span class="op">%&gt;%</span></span>
<span id="cb12-16"><a href="delineate-watersheds-for-analysis.html#cb12-16"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Site =</span> shd.names<span class="op">$</span>Name[i]) </span>
<span id="cb12-17"><a href="delineate-watersheds-for-analysis.html#cb12-17"></a>}</span>
<span id="cb12-18"><a href="delineate-watersheds-for-analysis.html#cb12-18"></a><span class="kw">endCluster</span>()</span>
<span id="cb12-19"><a href="delineate-watersheds-for-analysis.html#cb12-19"></a></span>
<span id="cb12-20"><a href="delineate-watersheds-for-analysis.html#cb12-20"></a>stack.df &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">&#39;rbind&#39;</span>,stack.list) </span>
<span id="cb12-21"><a href="delineate-watersheds-for-analysis.html#cb12-21"></a><span class="kw">names</span>(stack.df)[<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>] &lt;-<span class="st"> </span>e.names</span>
<span id="cb12-22"><a href="delineate-watersheds-for-analysis.html#cb12-22"></a></span>
<span id="cb12-23"><a href="delineate-watersheds-for-analysis.html#cb12-23"></a>  </span>
<span id="cb12-24"><a href="delineate-watersheds-for-analysis.html#cb12-24"></a></span>
<span id="cb12-25"><a href="delineate-watersheds-for-analysis.html#cb12-25"></a><span class="kw">head</span>(stack.df)</span>
<span id="cb12-26"><a href="delineate-watersheds-for-analysis.html#cb12-26"></a><span class="co">#Name the rows of this wide data frame</span></span>
<span id="cb12-27"><a href="delineate-watersheds-for-analysis.html#cb12-27"></a></span>
<span id="cb12-28"><a href="delineate-watersheds-for-analysis.html#cb12-28"></a><span class="kw">save</span>(stack.df,<span class="dt">file=</span><span class="st">&#39;data/out/UAA.E.Slope.Ref.RData&#39;</span>)</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="identifying-heavily-mined-watersheds.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="analysis-and-figures.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
